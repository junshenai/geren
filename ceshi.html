<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºè§†åŠ›è‡ªæµ‹</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8rem;
            margin-top: 10px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
            display: block;
            margin: 15px auto;
        }

        button:hover {
            background-color: #2980b9;
            transform: scale(1.03);
        }

        button:active {
            transform: scale(0.98);
        }

        /* è§†åŠ›è¡¨æ ·å¼ */
        .vision-chart {
            position: relative;
            width: 100%;
            height: 250px;
            background-color: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            overflow: hidden;
        }

        .e-letter {
            font-size: 60px;
            font-weight: bold;
            color: #333;
            transition: all 0.3s;
        }

        /* æ–¹å‘æŒ‰é’® */
        .direction-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
        }

        .direction-btn {
            aspect-ratio: 1;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .direction-btn:hover {
            background-color: #dfe6e9;
        }

        .direction-btn:active {
            transform: scale(0.95);
        }

        /* ç»“æœæ˜¾ç¤º */
        .result {
            text-align: center;
            margin: 30px 0;
        }

        .vision-value {
            font-size: 3rem;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        /* è®°å½•åˆ—è¡¨ */
        .records {
            margin-top: 30px;
        }

        .record-item {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        /* æç¤ºä¿¡æ¯ */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #e74c3c;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        /* æ¨ªå±æç¤º */
        .landscape-tip {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .landscape-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        /* é€‚é…æ¨ªå± */
        @media screen and (orientation: landscape) {
            .vision-chart {
                height: 300px;
            }

            .direction-buttons {
                max-width: 400px;
            }
        }

        /* é€‚é…å°å±å¹• */
        @media screen and (max-width: 360px) {
            h1 {
                font-size: 1.5rem;
            }

            .vision-chart {
                height: 300px;
            }

            .e-letter {
                font-size: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- æ¨ªå±æç¤º -->
    <div class="landscape-tip" id="landscapeTip">
        <div class="landscape-icon">ğŸ“±</div>
        <h2>è¯·æ—‹è½¬æ‰‹æœºè‡³æ¨ªå±æ¨¡å¼</h2>
        <p>è·å¾—æ›´å¥½çš„æµ‹è¯•ä½“éªŒ</p>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="notification" id="notification"></div>

    <div class="container">
        <h1>æ‰‹æœºè§†åŠ›è‡ªæµ‹</h1>

        <!-- å¼€å§‹é¡µé¢ -->
        <div class="card" id="startPage">
            <h2>æ¬¢è¿ä½¿ç”¨è§†åŠ›è‡ªæµ‹</h2>
            <p>æœ¬æµ‹è¯•ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—æ£€æŸ¥</p>
            <button id="startTest">å¼€å§‹æµ‹è¯•</button>
        </div>

        <!-- ç¯å¢ƒæ£€æµ‹é¡µé¢ -->
        <div class="card" id="environmentPage" style="display: none;">
            <h2>æµ‹è¯•ç¯å¢ƒå‡†å¤‡</h2>
            <p>1. è¯·ç¡®ä¿æµ‹è¯•ç¯å¢ƒå…‰çº¿å……è¶³</p>
            <p>2. è¯·æ‘˜æ‰çœ¼é•œæˆ–éšå½¢çœ¼é•œ</p>
            <p>3. è¯·ä¿æŒæ‰‹æœºå±å¹•æ¸…æ´</p>
            <button id="checkEnvironment">æ£€æŸ¥ç¯å¢ƒ</button>
            <button id="skipEnvironment">è·³è¿‡æ£€æŸ¥</button>
        </div>

        <!-- è·ç¦»æ£€æµ‹é¡µé¢ -->
        <div class="card" id="distancePage" style="display: none;">
            <h2>æµ‹è¯•è·ç¦»è°ƒæ•´</h2>
            <p>è¯·å°†æ‰‹æœºä¿æŒåœ¨çº¦50å˜ç±³çš„è·ç¦»</p>
            <div id="distanceStatus">æ­£åœ¨æ£€æµ‹è·ç¦»...</div>
            <button id="skipDistance">æˆ‘å·²æµ‹é‡å¥½è·ç¦»</button>
        </div>

        <!-- è§†åŠ›æµ‹è¯•é¡µé¢ -->
        <div class="card" id="testPage" style="display: none;">
            <h2>è§†åŠ›æµ‹è¯•</h2>
            <p>è¯·è¯†åˆ«ä¸‹é¢å­—æ¯"E"çš„å¼€å£æ–¹å‘</p>
            <div class="vision-chart">
                <div class="e-letter" id="eLetter">E</div>
            </div>
            <div class="direction-buttons">
                <div class="direction-btn" data-direction="up">â†‘</div>
                <div class="direction-btn" data-direction="left">â†</div>
                <div class="direction-btn" data-direction="right">â†’</div>
                <div class="direction-btn" data-direction="down">â†“</div>
            </div>
            <div id="currentLevel">å½“å‰çº§åˆ«: 0.1</div>
        </div>

        <!-- ç»“æœé¡µé¢ -->
        <div class="card" id="resultPage" style="display: none;">
            <h2>æµ‹è¯•ç»“æœ</h2>
            <div class="result">
                <p>æ‚¨çš„è§†åŠ›å€¼ä¸º:</p>
                <div class="vision-value" id="visionValue">1.0</div>
                <p id="visionSuggestion">æ‚¨çš„è§†åŠ›æ­£å¸¸ï¼Œè¯·ç»§ç»­ä¿æŒ</p>
            </div>

            <h3>æœ€è¿‘æµ‹è¯•è®°å½•</h3>
            <div class="records" id="recordsList"></div>

            <button id="retest">é‡æ–°æµ‹è¯•</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentLevel = 0; // 0-7 å¯¹åº” 0.1-1.5
        const visionLevels = [0.1, 0.2, 0.3, 0.5, 0.7, 1.0, 1.2, 1.5];
        let correctAnswers = 0;
        let totalAnswers = 0;
        let testRecords = JSON.parse(localStorage.getItem('visionTestRecords')) || [];
        let isTesting = false;

        // DOMå…ƒç´ 
        const startPage = document.getElementById('startPage');
        const environmentPage = document.getElementById('environmentPage');
        const distancePage = document.getElementById('distancePage');
        const testPage = document.getElementById('testPage');
        const resultPage = document.getElementById('resultPage');
        const startTestBtn = document.getElementById('startTest');
        const checkEnvironmentBtn = document.getElementById('checkEnvironment');
        const skipEnvironmentBtn = document.getElementById('skipEnvironment');
        const skipDistanceBtn = document.getElementById('skipDistance');
        const retestBtn = document.getElementById('retest');
        const eLetter = document.getElementById('eLetter');
        const directionBtns = document.querySelectorAll('.direction-btn');
        const currentLevelEl = document.getElementById('currentLevel');
        const visionValueEl = document.getElementById('visionValue');
        const visionSuggestionEl = document.getElementById('visionSuggestion');
        const recordsListEl = document.getElementById('recordsList');
        const notification = document.getElementById('notification');
        const landscapeTip = document.getElementById('landscapeTip');
        const distanceStatus = document.getElementById('distanceStatus');

        // åˆå§‹åŒ–
        function init() {
            // æ£€æŸ¥å±å¹•æ–¹å‘
            checkOrientation();
            window.addEventListener('resize', checkOrientation);

            // äº‹ä»¶ç›‘å¬å™¨
            startTestBtn.addEventListener('click', startTest);
            checkEnvironmentBtn.addEventListener('click', checkEnvironment);
            skipEnvironmentBtn.addEventListener('click', () => showPage(distancePage));
            skipDistanceBtn.addEventListener('click', startVisionTest);
            retestBtn.addEventListener('click', startTest);

            // æ–¹å‘æŒ‰é’®äº‹ä»¶
            directionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (isTesting) {
                        checkAnswer(btn.dataset.direction);
                    }
                });
            });

            // æ›´æ–°è®°å½•åˆ—è¡¨
            updateRecordsList();
        }

        // æ£€æŸ¥å±å¹•æ–¹å‘
        function checkOrientation() {
            // å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿å±å¹•æ—‹è½¬å®Œæˆ
            setTimeout(() => {
                // ä¸å†å¼ºåˆ¶æ¨ªå±ï¼Œä»…æ˜¾ç¤ºæç¤º
                landscapeTip.style.display = 'none';
            }, 100);
        }

        // å¼€å§‹æµ‹è¯•
        function startTest() {
            // é‡ç½®æµ‹è¯•å‚æ•°
            currentLevel = 0;
            correctAnswers = 0;
            totalAnswers = 0;
            isTesting = false;

            // æ˜¾ç¤ºç¯å¢ƒæ£€æµ‹é¡µé¢
            showPage(environmentPage);
        }

        // æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            // æ¨¡æ‹Ÿç¯å¢ƒæ£€æµ‹
            showNotification('ç¯å¢ƒå…‰çº¿è‰¯å¥½');
            setTimeout(() => {
                showNotification('è¯·ç¡®ä¿å·²æ‘˜æ‰çœ¼é•œ');
                setTimeout(() => {
                    showPage(distancePage);
                    simulateDistanceDetection();
                }, 1500);
            }, 1500);
        }

        // æ¨¡æ‹Ÿè·ç¦»æ£€æµ‹
        function simulateDistanceDetection() {
            let distance = 30; // æ¨¡æ‹Ÿåˆå§‹è·ç¦»30cm
            distanceStatus.textContent = `å½“å‰è·ç¦»: ${distance}cm (å»ºè®®50cm)`;

            // æ¨¡æ‹Ÿè·ç¦»é€æ¸å¢åŠ 
            const interval = setInterval(() => {
                distance += 5;
                distanceStatus.textContent = `å½“å‰è·ç¦»: ${distance}cm (å»ºè®®50cm)`;

                if (distance >= 50) {
                    clearInterval(interval);
                    distanceStatus.textContent = `è·ç¦»åˆé€‚: ${distance}cm`;
                    showNotification('è·ç¦»å·²è°ƒæ•´åˆé€‚ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
                }
            }, 800);
        }

        // å¼€å§‹è§†åŠ›æµ‹è¯•
        function startVisionTest() {
            showPage(testPage);
            currentLevel = 0;
            correctAnswers = 0;
            totalAnswers = 0;
            isTesting = true;
            generateELetter();
            updateLevelDisplay();
        }

        // ç”ŸæˆEå­—æ¯
        function generateELetter() {
            // éšæœºæ–¹å‘
            const direction = ['up', 'down', 'left', 'right'][Math.floor(Math.random() * 4)];
            eLetter.dataset.direction = direction;

            // æ ¹æ®çº§åˆ«è°ƒæ•´å¤§å°
            const size = 80 - currentLevel * 8;
            eLetter.style.fontSize = `${size}px`;

            // æ ¹æ®æ–¹å‘æ—‹è½¬å­—æ¯
            let rotation = 0;
            if (direction === 'up') {
                rotation = 270;
            } else if (direction === 'right') {
                rotation = 0;
            } else if (direction === 'down') {
                rotation = 90;
            } else if (direction === 'left') {
                rotation = 180;
            }

            // å¢åŠ å°è§’åº¦æ—‹è½¬å¢åŠ éš¾åº¦
            if (currentLevel > 3) {
                rotation += Math.random() * 10 - 5;
            }

            eLetter.style.transform = `rotate(${rotation}deg)`;

            // æ›´æ–°çº§åˆ«æ˜¾ç¤º
            updateLevelDisplay();
        }

        // æ›´æ–°çº§åˆ«æ˜¾ç¤º
        function updateLevelDisplay() {
            currentLevelEl.textContent = `å½“å‰çº§åˆ«: ${visionLevels[currentLevel]}`;
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(userDirection) {
            const correctDirection = eLetter.dataset.direction;
            totalAnswers++;

            if (userDirection === correctDirection) {
                correctAnswers++;
                showNotification('æ­£ç¡®');
            } else {
                showNotification('é”™è¯¯');
            }

            // æ¯çº§åˆ«æµ‹è¯•3æ¬¡
            if (totalAnswers % 3 === 0) {
                // è¯„ä¼°è¯¥çº§åˆ«æ˜¯å¦é€šè¿‡
                if (correctAnswers >= 2) {
                    // é€šè¿‡ï¼Œè¿›å…¥ä¸‹ä¸€çº§
                    currentLevel++;
                    if (currentLevel >= visionLevels.length) {
                        // å·²å®Œæˆæ‰€æœ‰çº§åˆ«
                        finishTest();
                    } else {
                        showNotification(`å·²é€šè¿‡çº§åˆ« ${visionLevels[currentLevel-1]}ï¼Œè¿›å…¥çº§åˆ« ${visionLevels[currentLevel]}`);
                        setTimeout(generateELetter, 1000);
                    }
                } else {
                    // æœªé€šè¿‡ï¼Œç»“æŸæµ‹è¯•
                    finishTest();
                }
                // é‡ç½®è®¡æ•°
                correctAnswers = 0;
            } else {
                // ç»§ç»­è¯¥çº§åˆ«æµ‹è¯•
                setTimeout(generateELetter, 1000);
            }
        }

        // å®Œæˆæµ‹è¯•
        function finishTest() {
            isTesting = false;

            // è®¡ç®—è§†åŠ›å€¼
            let visionValue = visionLevels[Math.max(0, currentLevel - 1)];
            if (currentLevel === 0) visionValue = 0.1;

            // ä¿å­˜æµ‹è¯•è®°å½•
            const record = {
                date: new Date().toLocaleString(),
                value: visionValue
            };

            testRecords.unshift(record);
            // åªä¿ç•™æœ€è¿‘3æ¡è®°å½•
            if (testRecords.length > 3) {
                testRecords = testRecords.slice(0, 3);
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('visionTestRecords', JSON.stringify(testRecords));

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            visionValueEl.textContent = visionValue;

            // ç»™å‡ºå»ºè®®
            if (visionValue >= 1.0) {
                visionSuggestionEl.textContent = 'æ‚¨çš„è§†åŠ›æ­£å¸¸ï¼Œè¯·ç»§ç»­ä¿æŒ';
            } else if (visionValue >= 0.5) {
                visionSuggestionEl.textContent = 'æ‚¨çš„è§†åŠ›ç•¥ä½ï¼Œå»ºè®®å®šæœŸå¤æŸ¥';
            } else {
                visionSuggestionEl.textContent = 'æ‚¨çš„è§†åŠ›è¾ƒå·®ï¼Œå»ºè®®å°½å¿«å°±åŒ»æ£€æŸ¥';
            }

            // æ›´æ–°è®°å½•åˆ—è¡¨
            updateRecordsList();

            // æ˜¾ç¤ºç»“æœé¡µé¢
            showPage(resultPage);
        }

        // æ›´æ–°è®°å½•åˆ—è¡¨
        function updateRecordsList() {
            recordsListEl.innerHTML = '';

            testRecords.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                recordItem.innerHTML = `<p>æ—¥æœŸ: ${record.date}</p><p>è§†åŠ›å€¼: ${record.value}</p>`;
                recordsListEl.appendChild(recordItem);
            });
        }

        // æ˜¾ç¤ºé¡µé¢
        function showPage(page) {
            // éšè—æ‰€æœ‰é¡µé¢
            startPage.style.display = 'none';
            environmentPage.style.display = 'none';
            distancePage.style.display = 'none';
            testPage.style.display = 'none';
            resultPage.style.display = 'none';

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            page.style.display = 'block';
        }

        // æ˜¾ç¤ºæç¤º
        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>